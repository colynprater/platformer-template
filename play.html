<html>

<body>
  <div id="wrapper">
    <canvas id="gameCanvas" width="1000", height="600"></canvas>
  </div>

</body>

<script src="js/models.js"></script>
<script src="js/resolver.js"></script>
<script src="js/collisions.js"></script>
<script src="js/utils.js"></script>

<script>
const PLAYER_WIDTH      = 20;
const PLAYER_HEIGHT     = 35;
const PLAYER_MAX_SPEED  = 6;
const PLAYER_ACCEL      = 2;
const PLAYER_SLOW_RATE  = 0.75;
const TERMINAL_VELOCITY = 25;
const JUMP_POWER        = 20;
const GRAVITY           = 0.75;

var wrapper = document.getElementById('wrapper')

var canvas;
var ctx;

var player;

var player = new Player({x: 0, y: 0});
var collidables = [];

window.onload = function() {
  canvas = document.getElementById('gameCanvas');
  ctx = canvas.getContext('2d');

  initFloor();
  initPlayer();

  var framesPerSecond = 60;

  document.addEventListener('keydown', keyDownListener);
  document.addEventListener('keyup', keyUpListener);

  setInterval(function() {
    update();
    drawEverything();
  }, 1000/framesPerSecond)
}

function keyUpListener(evt) {
  var keyCode = evt.keyCode;

  if (keyCode == 37) { // left arrow key
    player.walking = false;
  }
  if (keyCode == 39) { // right arrow key
    player.walking = false;
  }
}

function keyDownListener(evt) {
  var keyCode = evt.keyCode;

  if (keyCode == 16) { // shift key
    player.jump()
  }

  if (keyCode == 37) { // left arrow key
    player.walking = true;
    reversePlayerDirectionAndMomentum(keyCode)
  }

  if (keyCode == 39) { // right arrow key
    player.walking = true;
    reversePlayerDirectionAndMomentum(keyCode)
  }
}

function collideHorizontally() {
  var blockOnLeft  = blockAtObjLeft(player, collidables)
  var blockOnRight = blockAtObjRight(player, collidables)

  if (blockOnLeft) {
    player.momentum = 0;
    player.x = Resolver.right(blockOnLeft) + (PLAYER_WIDTH / 2) + 2
  } else if (blockOnRight) {
    player.momentum = 0;
    player.x = Resolver.left(blockOnRight) - (PLAYER_WIDTH / 2) - 2
  }
}

function collideVertically() {
  var blockAbove = blockAtObjTop(player, collidables)

  if (blockAbove) {
    player.velocity = 0;
    player.y = Resolver.bottom(blockAbove) + (PLAYER_HEIGHT / 2) + 2
  }
}

function reversePlayerDirectionAndMomentum(keyCode) {
  var desiredDirection = keyCode == 39 ? 0 : 1;
  var needToTurnAround =
    (keyCode == 39 && player.facingRight()) ||
    (keyCode == 37 && player.facingLeft())

  if (needToTurnAround && player.momentum > 0) {
    player.momentum -= (PLAYER_MAX_SPEED - PLAYER_MAX_SPEED / 3);
  } else {
    player.direction = desiredDirection;
    increasePlayerMomentum();
  }
}

function update() {
  decreasePlayerMomentum();
  movePlayer();
  increasePlayerPlummet();
  groundPlayer();
  dropPlayer();
  collideHorizontally();
  collideVertically();
}

function drawEverything() {
  colourRect(0, 0, canvas.width, canvas.height, 'black') // Background
  drawPlayer();
  drawCollidables();
}

function initFloor() {
  collidables.push(new Collidable({
    x: canvas.width,
    y: canvas.height,
    width: canvas.width * 2,
    height: (canvas.height / 6),
    colour: 'pink'
  }))

  collidables.push(new Collidable({
    x: (canvas.width / 2) - 30,
    y: (canvas.height / 6) * 4.5,
    width: 100,
    height: 40,
    colour: 'green'
  }))

  collidables.push(new Collidable({
    x: (canvas.width / 2) + 30,
    y: (canvas.height / 6) * 2,
    width: 100,
    height: 50,
    colour: 'green'
  }))

  collidables.push(new Collidable({
    x: (canvas.width / 2) - 100,
    y: (canvas.height / 6) * 5.5,
    width: 100,
    height: 50,
    colour: 'green'
  }))

  collidables.push(new Collidable({
    x: (canvas.width / 2) + 60,
    y: (canvas.height / 6) * 5.5,
    width: 100,
    height: 50,
    colour: 'green'
  }))
}

function movePlayer() {
  if (player.momentum) {
    player.x += player.facingLeft() ? player.momentum : -player.momentum;
  }

  if (!player.grounded) {
    player.y += player.plummet - player.velocity;
  }
}

function increasePlayerPlummet() {
  player.velocity--;
  if (player.velocity < 1) player.velocity = 0;
  if (!player.grounded && player.plummet <= TERMINAL_VELOCITY) player.plummet += GRAVITY;
}

function groundPlayer() {
  var blockStoodOn = blockAtObjBottom(player, collidables)

  if (blockStoodOn) {
    player.y = Resolver.top(blockStoodOn) - player.height / 2;
    player.plummet = 0;
    player.grounded = true;
  }
}

function dropPlayer() {
  if (!blockAtObjBottom(player, collidables)) player.grounded = false;
}

function decreasePlayerMomentum() {
  if (!player.walking && player.momentum >= 0 && player.grounded) {
    if (player.grounded) player.momentum -= PLAYER_SLOW_RATE;
    if (!player.grounded) player.momentum -= PLAYER_SLOW_RATE / 2;
  }
  if (player.momentum < 0) player.momentum = 0;
}

function increasePlayerMomentum() {
  if (player.walking) {
    player.momentum += PLAYER_MAX_SPEED - PLAYER_ACCEL;// TODO work out fluid acceleration alg
  }
  if (player.momentum > PLAYER_MAX_SPEED) player.momentum = PLAYER_MAX_SPEED;
}

function initPlayer() {
  player.x = canvas.width / 2;
  player.y = (canvas.height / 6) * 1;
  player.width = PLAYER_WIDTH;
  player.height = PLAYER_HEIGHT;
  player.colour = 'blue';
}

function drawCollidables() {
  collidables.forEach((collidable) => {
    colourRect(
      collidable.x - collidable.width / 2,
      collidable.y - collidable.height / 2,
      collidable.width,
      collidable.height,
      collidable.colour
    )
    drawDebugDots(collidable)
  })
}
function drawPlayer() {
  colourRect(
    player.x - player.width / 2,
    player.y - player.height / 2,
    player.width,
    player.height,
    player.colour
  )

  drawDebugDots(player)
}

</script>

<style>
  body {
    color: white;
    text-align: center;
    background-color: black;
  }
  canvas {
    margin: 12px;
    border-style: solid;
    border-color: white;
  }
  #wrapper {

  }
</style>
</html>
