<html>

<body>
  <div id="wrapper">
    <canvas id="gameCanvas" width="1000", height="600"></canvas>
  </div>

</body>

<script src="js/utils.js"></script>
<script>
const PLAYER_WIDTH  = 20;
const PLAYER_HEIGHT = 35;
const PLAYER_MAX_SPEED = 6;
const PLAYER_SLOW_RATE = 0.2;
const GRAVITY = 10;

var wrapper = document.getElementById('wrapper')

var canvas;
var ctx;

var player;

class Sprite {
  constructor(opts) {
    this.x        = opts.x
    this.y        = opts.y
    this.direction   = opts.direction || 0 // 0 is left, 1 is right
    this.width    = opts.width    || 10
    this.height   = opts.height   || 10
  }

  facingLeft() {
    return this.direction == 0;
  }

  facingRight() {
    return this.direction == 1;
  }
}

class Player extends Sprite {
  constructor(opts) {
    super(opts)
    this.momentum = opts.momentum || 0
    this.velocity      = opts.velocity      || 0
    this.walking  = opts.walking  || false
  }

  // functions
}

class Block { // does this need to be a class?

  constructor(options) {
    this.x      = options.x || 0;
    this.y      = options.y || 0;
    this.height = options.height || 0;
    this.width  = options.width  || 0;
    this.colour  = options.colour  || 'white';
  }

}

var floor = new Block({});
var player = new Player({x: 0, y: 0});

window.onload = function() {
  canvas = document.getElementById('gameCanvas');
  ctx = canvas.getContext('2d');

  initializeFloor();
  initializePlayer();

  var framesPerSecond = 60;

  document.addEventListener('keydown', keyDownListener);
  document.addEventListener('keyup', keyUpListener);

  setInterval(function() {
    update();
    drawEverything();
  }, 1000/framesPerSecond)
}

function keyUpListener(evt) {
  var keyCode = evt.keyCode;

  if (keyCode == 32) {
    // car.idle = true;
  }
  if (keyCode == 37) {
    player.walking = false;
  }
  if (keyCode == 39) {
    player.walking = false;
  }
}

function keyDownListener(evt) {
  var keyCode = evt.keyCode;

  if (keyCode == 32) {
    // TODO jump
  }
  if (keyCode == 37) { // LEFT
    player.walking = true;
    reversePlayerDirectionAndMomentum(keyCode)
  }

  if (keyCode == 39) { // RIGHT
    player.walking = true;
    reversePlayerDirectionAndMomentum(keyCode)
  }
}

function reversePlayerDirectionAndMomentum(keyCode) {
  var desiredDirection = keyCode == 39 ? 0 : 1;
  var needToTurnAround =
    (keyCode == 39 && player.facingRight()) ||
    (keyCode == 37 && player.facingLeft())

  if (needToTurnAround && player.momentum > 0) {
    player.momentum -= 4;
  } else {
    player.direction = desiredDirection;
    increasePlayerMomentum();
  }
}

function update() {
  decreasePlayerMomentum();
  movePlayer();
}

function drawEverything() {
  colourRect(0, 0, canvas.width, canvas.height, 'black') // Background
  drawPlayer();
  drawFloor();
}

function initializeFloor() {
  floor.x = 0;
  floor.y = (canvas.height / 6) * 5;
  floor.width = canvas.width;
  floor.height = canvas.height / 6;
  floor.colour = 'pink';
}

function movePlayer() { // TODO Refactor with a ternary
  if (player.momentum) {
    if (player.facingLeft()) {
      player.x += player.momentum;
    } else if (player.facingRight()) {
      player.x -= player.momentum;
    }
  }
}

function decreasePlayerMomentum() {
  if (!player.walking && player.momentum >= 0) {
    player.momentum -= PLAYER_SLOW_RATE;

    if (player.momentum < 0) player.momentum = 0;
  }
}

function increasePlayerMomentum() {
  if (player.walking && player.momentum <= PLAYER_MAX_SPEED) {
    player.momentum += 1; // TODO make accel const
  }
}

function initializePlayer() {
  player.x = canvas.width / 2;
  player.y = (canvas.height / 6) * 4;
  player.width = PLAYER_WIDTH;
  player.height = PLAYER_HEIGHT;
  player.colour = 'blue';
}

function drawFloor() {
  colourRect(floor.x, floor.y, floor.width, floor.height, floor.colour)
}
function drawPlayer() {

  colourRect(
    player.x - player.width / 2,
    player.y - player.height / 2,
    player.width,
    player.height,
    player.colour
  )

  // drawDebugDots(player)
}

</script>

<style>
  body {
    color: white;
    text-align: center;
    background-color: black;
  }
  canvas {
    margin: 12px;
    border-style: solid;
    border-color: white;
  }
  #wrapper {

  }
</style>
</html>
